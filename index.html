<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DESIGN TEAM DASHBOARD</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <link href="https://fonts.googleapis.com/css2?family=Alexandria:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <!-- ضع هذا داخل الهيدر في صفحة الداشبورد -->
<a href="designer-tasks.html" class="btn btn-outline-light btn-sm" title="Tasks Details" style="position:absolute; right:12px; top:12px; display:flex; align-items:center; gap:6px;">
  <!-- آيقونة تقرير تفصيلي (SVG خفيف) -->
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M7 4h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z" stroke="currentColor" stroke-width="1.6"/>
    <path d="M9 8h6M9 12h6M9 16h4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
  </svg>
  <span class="d-none d-sm-inline">Details</span>
</a>
<!-- Actions: Details + Quick Tools -->
<div class="d-flex justify-content-end align-items-center gap-2 mb-2">
  <!-- زر التفاصيل للدخول لصفحة Designer Tasks -->
  <a href="designer-tasks.html" class="btn btn-outline-light btn-sm" title="Designer Tasks">
    Details
  </a>

  <!-- روابط الأدوات كأزرار صغيرة -->
  <a href="https://ramymaraei.github.io/banner-checker/" target="_blank" rel="noopener" class="btn btn-outline-light btn-sm" title="Banner Checker">
    Banner Checker
  </a>

  <a href="https://ramymaraei.github.io/thumbnail-checker/" target="_blank" rel="noopener" class="btn btn-outline-light btn-sm" title="Thumbnail Checker">
    Thumbnail Checker
  </a>

  <a href="https://ramymaraei.github.io/banner-checker/QRCodeReader.html" target="_blank" rel="noopener" class="btn btn-outline-light btn-sm" title="QR Code Scanner">
    QR Code Scanner
  </a>

  <a href="https://www.notion.so/alfan/9f15c45fc4054678916c26d0ace70e5a?v=977fb0265c2f43ba944a43ee498c45d7&source=copy_link" target="_blank" rel="noopener" class="btn btn-outline-light btn-sm" title="Designs Requests on Notion">
    Designs Requests
  </a>

  <a href="https://www.notion.so/alfan/DESIGN-BOARD-f24d153cee3c4a529e02d597e59f8c77?source=copy_link#c61ac4473d9a40ed9aee7e2876717ba8" target="_blank" rel="noopener" class="btn btn-outline-light btn-sm" title="Syndication Requests on Notion">
    Syndication Requests
  </a>

  <a href="https://www.notion.so/alfan/aaf31625534d4f09b70f2d9bb2de402f?v=72d064c500704538a29a04c9cda30c4b&source=copy_link" target="_blank" rel="noopener" class="btn btn-outline-light btn-sm" title="Design Request Form">
    Design Request Form
  </a>
</div>

  <style>
    :root{ --bg: #f4f0ed; --text: #21000e; --box: #ffffff; --border: #21000e22; --control: #ffffff; --control-border:#21000e55; --red: #ff002b; --chart-base: #21000E; --link: #ff002b; }
    body { background: var(--bg); color: var(--text); font-family: 'Alexandria', sans-serif; }
    .card { background: var(--box); border: 1px solid var(--border); }
    .form-select, .form-control { background: var(--control); color: var(--text); border-color: var(--control-border); }
    .btn-primary { background: var(--red) !important; border-color: var(--red) !important; color: #fff !important; }
    .btn-outline-light { border-color: var(--red) !important; color: var(--red) !important; }
    h1, .form-label { color: var(--red); }
    .kpi h2 { font-weight: 800; color: var(--text); }
    .kpi .small { color: var(--text) !important; }
    .muted { color: #6b7280; font-size: .8rem; }
    #clientSelect.form-select { font-size: .9rem; }
    #clientSearch { font-size: .9rem; margin-bottom: .4rem; }
    footer { text-align: center; padding: 1rem; font-size: 0.9rem; color: var(--text); border-top: 1px solid var(--border); margin-top: 1rem; }

    /* Typeahead */
    .typeahead { position: relative; }
    .typeahead-list{
      position: absolute; top:100%; left:0; right:0; z-index:1000;
      background: var(--box); border:1px solid var(--border); border-top:none;
      max-height: 240px; overflow:auto; box-shadow:0 6px 16px rgba(0,0,0,.06);
    }
    .typeahead-item{ padding:.5rem .75rem; cursor:pointer; }
    .typeahead-item:hover, .typeahead-item.active{ background:#fff0f3; }
    .typeahead-empty{ padding:.5rem .75rem; color:#6b7280; }
    .typeahead mark{ background:transparent; color:var(--red); font-weight:700; }
  </style>
</head>
<body>
  <div class="container py-4">

    <!-- Logo -->
    <div class="d-flex align-items-center justify-content-center mb-2">
      <img src="https://ramymaraei.github.io/banner-checker/ALFAN_LOGO-Small.png" alt="ALFAN Logo" style="max-height:56px;">
    </div>
    <!-- Title -->
    <div class="d-flex align-items-center justify-content-center mb-3">
      <h1 class="fs-4 m-0 text-center">DESIGN TEAM DASHBOARD</h1>
    </div>

    <div class="card p-3 mb-3">
      <div class="row g-2 align-items-end">
        <div class="col-md-3"><label class="form-label">Year</label><select id="yearSelect" class="form-select"><option value="all">All</option></select></div>
        <div class="col-md-3"><label class="form-label">From</label><input id="fromDate" type="date" class="form-control" /><div class="muted" id="fromDateDisp"></div></div>
        <div class="col-md-3"><label class="form-label">To</label><input id="toDate" type="date" class="form-control" /><div class="muted" id="toDateDisp"></div></div>
        <div class="col-md-3 d-flex gap-2">
          <button id="btnThisWeek" class="btn btn-outline-light w-100">This Week</button>
          <button id="btnApply" class="btn btn-primary w-100">Apply</button>
          <button id="btnClear" class="btn btn-outline-light w-100">Clear</button>
        </div>
      </div>
    </div>

    <div class="row g-3 kpi">
      <div class="col-md-4"><div class="card p-3 h-100"><span class="small">Year Total</span><h2 id="kpiYearTotal">--</h2></div></div>
      <div class="col-md-4"><div class="card p-3 h-100"><span class="small">Range Total</span><h2 id="kpiRangeTotal">--</h2></div></div>
      <div class="col-md-4"><div class="card p-3 h-100"><span class="small">Daily Average</span><h2 id="kpiRangeAvg">--</h2></div></div>
    </div>

    <div class="card p-3 mt-3"><div id="chart"></div></div>
    <div class="row mt-3" id="designerTotals"></div>
    <div class="row mt-3" id="designerPies"></div>

    <div class="card p-3 mt-3">
      <div class="row g-3">
        <div class="col-md-6"><div id="typeBar"></div></div>
        <div class="col-md-6"><div id="typePie"></div></div>
      </div>
    </div>

    <!-- Monthly + Yearly -->
    <div class="card p-3 mt-3">
      <div class="row g-3">
        <div class="col-md-6">
          <h6>Monthly Comparison</h6>
          <div id="monthsBar"></div>
          <div class="muted" id="monthsHint"></div>
        </div>
        <div class="col-md-6">
          <h6>Yearly Comparison</h6>
          <div id="yearsBar"></div>
        </div>
      </div>
    </div>

    <div class="card p-3 mt-3">
      <label class="form-label">Select Channel</label>

      <!-- Typeahead -->
      <div class="typeahead">
        <input id="clientSearch" type="text" class="form-control" placeholder="Search channel..." autocomplete="off" />
        <div id="clientSuggest" class="typeahead-list" style="display:none;"></div>
      </div>

      <!-- Fallback select -->
      <select id="clientSelect" class="form-select form-select-sm mb-2 mt-2"></select>

      <div id="clientTotal" class="mb-2"></div>
      <div id="clientTypes" class="mb-2"></div>
      <div id="clientChannels" class="mb-2"></div>
      <div id="clientLastDate" class="mb-2"></div>
      <div id="clientDesigners"></div>
    </div>

    <footer>
      شركة الفان – تصميم وتنفيذ رامي مرعي | Alfan - DESIGNTeam Dashboard - Ramy Maraei © 2025
    </footer>
  </div>

  <script>
  // ===== CONFIG =====
  const SHEET_API = 'https://script.google.com/macros/s/AKfycbzl7CV83GMqgUMEK7CZlAJ-2s4aruOYeistkcpX_6mozP_e4c3DG4eMIEN7GQZcx4B6/exec';
  const CSS = getComputedStyle(document.documentElement);
  const CHART_BASE = CSS.getPropertyValue('--chart-base').trim() || '#21000E';
  const HEAD_RED = CSS.getPropertyValue('--red').trim() || '#ff002b';

  // ثابت ألوان موحّد لكل نوع
  const TYPE_COLOR_MAP = {
    'Snap Tiles': '#fbbc04',             // Snapchat Tile - أصفر
    'Snap Theme': '#ffd966',
    'Banners': '#990000',                 // YouTube Banner - أحمر
    'Thumbnails': '#3c78d8',
    'Covers': '#351c75',
    'Edit Covers': '#674ea7',
    'Logos / Typography': '#c27ba0',
    'Unknown': '#9ca3af'
  };

  // توحيد أسماء الأنواع
  function canonicalType(raw){
    if(!raw) return 'Unknown';
    const s = String(raw).trim().toLowerCase();

    if (['snap tiles','snap tile','snapchat tile','snapchat tiles','snap-tiles'].includes(s)) return 'Snap Tiles';
    if (['snap theme','snapchat theme'].includes(s)) return 'Snap Theme';
    if (['banners','banner','youtube banner','yt banner','youtube banners'].includes(s)) return 'Banners';
    if (['thumbnails','thumbnail','youtube thumbnail','yt thumbnail'].includes(s)) return 'Thumbnails';
    if (['covers','cover'].includes(s)) return 'Covers';
    if (['edit covers','cover edit','edit cover'].includes(s)) return 'Edit Covers';
    if ([
      'logos / typography','logo / typography','logos & typography','logo&typography',
      'logos','logo','typography'
    ].includes(s)) return 'Logos / Typography';

    return String(raw).trim();
  }
  function colorForType(name){
    const key = canonicalType(name);
    return TYPE_COLOR_MAP[key] || TYPE_COLOR_MAP['Unknown'];
  }

  const CALM_FALLBACKS = ['#6b7280','#9ca3af','#94a3b8','#a3b18a','#bdb2ff','#8ecae6','#bde0fe','#a8dadc'];

  let RAW = [];
  let areaChart = null, typeBarChart = null, typePieChart = null, monthsChart = null, yearsChart = null;
  let LAST_FILTERED = [];
  let CLIENTS = [];

  // ===== Number normalization =====
  function normalizeQty(v){
    if (v === null || v === undefined) return 0;
    if (typeof v === 'number' && isFinite(v)) return v;
    let s = String(v).trim();
    const ar = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
    s = s.replace(/[٠-٩]/g, d => ar[d]);
    s = s.replace(/[\u066C,]/g, '');
    s = s.replace(/\u066B/g, '.');
    if (/^[\d.\-+\s]+$/.test(s) && s.includes('+')) {
      return s.split('+').reduce((a,p)=> a+(parseFloat(p)||0), 0);
    }
    const n = parseFloat(s);
    return isFinite(n) ? n : 0;
  }

  // ===== Date helpers =====
  function toUTCDateOnly(y,m,d){ return new Date(Date.UTC(y,m-1,d)); }

  function parseDateOnly(input){
    if (input instanceof Date) {
      return toUTCDateOnly(input.getFullYear(), input.getMonth()+1, input.getDate());
    }
    const s = String(input).trim();
    let m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (m) return toUTCDateOnly(+m[1], +m[2], +m[3]);
    const dtTry = new Date(s);
    if (!isNaN(dtTry)) {
      return toUTCDateOnly(dtTry.getFullYear(), dtTry.getMonth()+1, dtTry.getDate());
    }
    const parts = s.split(/[^0-9]/).filter(Boolean).map(Number);
    if (parts.length >= 3){
      let a=parts[0], b=parts[1], c=parts[2];
      if (a>31 && b<=12) return toUTCDateOnly(a,b,c);
      if (a>12) return toUTCDateOnly(c,b,a);
      if (b>12) return toUTCDateOnly(c,a,b);
      return toUTCDateOnly(c,b,a);
    }
    const now = new Date();
    return toUTCDateOnly(now.getFullYear(), now.getMonth()+1, now.getDate());
  }

  function fromISODateOnly(iso){ const [Y,M,D] = iso.split('-').map(Number); return toUTCDateOnly(Y,M,D); }
  function fmtDDMMYYYY_UTC(d){ return `${String(d.getUTCDate()).padStart(2,'0')}/${String(d.getUTCMonth()+1).padStart(2,'0')}/${d.getUTCFullYear()}`; }

  // ===== Data utils =====
  function sumQty(rows){ let t=0; for (const r of rows) t += normalizeQty(r.qty); return t; }

  async function loadData(){
    try{
      const res = await fetch(SHEET_API, { cache: 'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const json = await res.json();
      return (Array.isArray(json)?json:[]).map(r=>{
        const dateOnly = parseDateOnly(r.Date);
        return {
          date: dateOnly,
          qty: normalizeQty(r.Quantity),
          type: (r.Type||'').trim(),
          designer: (r.Designer||'').trim(),
          client: (r.Client||'').trim(),
          channel: String(r['Channel ID'] ?? '').trim()
        };
      }).filter(r=> r.date instanceof Date && !isNaN(r.date.getTime()));
    }catch(e){ console.error(e); return []; }
  }

  function groupByDay(data){
    const map = new Map();
    data.forEach(r=>{
      const k = fmtDDMMYYYY_UTC(r.date);
      map.set(k, (map.get(k)||0) + normalizeQty(r.qty));
    });
    const labels = Array.from(map.keys()).sort((a,b)=>{
      const [da,ma,ya] = a.split('/').map(Number); const [db,mb,yb] = b.split('/').map(Number);
      return Date.UTC(ya,ma-1,da) - Date.UTC(yb,mb-1,db);
    });
    return { labels, series: labels.map(l=>map.get(l)) };
  }

  // ===== Charts =====
  function drawMainArea(data){
    const {labels, series} = groupByDay(data);
    const opts = {
      chart:{ type:'area', height:320, toolbar:{show:false}, foreColor: CHART_BASE },
      colors:[CHART_BASE],
      series:[{ name:'Designs', data: series }],
      xaxis:{ categories: labels },
      dataLabels:{enabled:false},
      stroke:{ curve:'smooth', width:3 },
      fill:{ type:'gradient', gradient:{ opacityFrom:.25, opacityTo:.05 } }
    };
    const el = document.querySelector('#chart');
    if(!areaChart){ areaChart = new ApexCharts(el, opts); areaChart.render(); }
    else { areaChart.updateOptions({ xaxis:{ categories: labels }, chart:{ foreColor: CHART_BASE }, colors:[CHART_BASE] }); areaChart.updateSeries([{name:'Designs', data: series}]); }
  }

  function drawDesignerTotals(data){
    const c = document.getElementById('designerTotals'); c.innerHTML='';
    const designers = [...new Set(data.map(r=>r.designer))].filter(Boolean);
    designers.forEach(d=>{
      const total = sumQty(data.filter(r=>r.designer===d));
      const div = document.createElement('div'); div.className='col-12 col-md-4';
      div.innerHTML = `<div class="card p-3 h-100"><span class="small">${d}</span><h2>${total}</h2></div>`;
      c.appendChild(div);
    });
  }

  function drawDesignerPies(data){
    const container = document.getElementById('designerPies'); container.innerHTML='';
    const designers = [...new Set(data.map(r=>r.designer))].filter(Boolean);
    designers.forEach(d=>{
      const byType = {};
      data.filter(r=>r.designer===d).forEach(r=>{
        const k = canonicalType(r.type) || 'Unknown';
        byType[k]=(byType[k]||0)+normalizeQty(r.qty);
      });
      const labels = Object.keys(byType);
      const series = labels.map(k=>byType[k]);
      const colors = labels.map(label => colorForType(label));

      const wrap = document.createElement('div'); wrap.className='col-12 col-md-4'; const div = document.createElement('div'); wrap.appendChild(div); container.appendChild(wrap);
      new ApexCharts(div,{
        chart:{type:'pie', height:300, foreColor: CHART_BASE},
        series, labels, colors,
        title:{ text:d, style:{ color: HEAD_RED } },
        legend:{ position:'bottom' }
      }).render();
    });
  }

function drawTypeBar(data){
  const byType = {};
  data.forEach(r=>{
    const k = canonicalType(r.type) || 'Unknown';
    byType[k] = (byType[k] || 0) + normalizeQty(r.qty);
  });

  const cats = Object.keys(byType);
  const vals = cats.map(k => byType[k]);

  const opts = {
    chart:{ type:'bar', height:350, foreColor: CHART_BASE, toolbar:{show:false} },
    colors:[HEAD_RED],                 // لون أحمر موحد
    plotOptions:{ bar:{ distributed:false } }, // منع توزيع ألوان مختلفة
    series:[{ name:'Designs', data: vals }],
    xaxis:{ categories: cats },
    dataLabels:{ enabled:false }
  };

  if (typeBarChart){ typeBarChart.destroy(); typeBarChart = null; }
  typeBarChart = new ApexCharts(document.querySelector('#typeBar'), opts);
  typeBarChart.render();
}


  function drawTypePie(data){
    const byType = {};
    data.forEach(r=>{
      const k = canonicalType(r.type) || 'Unknown';
      byType[k] = (byType[k] || 0) + normalizeQty(r.qty);
    });
    const cats   = Object.keys(byType);
    const vals   = cats.map(k => byType[k]);
    const colors = cats.map(t => colorForType(t));
    const opts = {
      chart:{ type:'pie', height:350, foreColor: CHART_BASE },
      colors,
      series: vals,
      labels: cats,
      legend:{ position:'bottom' },
      dataLabels:{ enabled:true },
      title:{ text:'By Type (Pie)', style:{ color: HEAD_RED } }
    };
    if (typePieChart){ typePieChart.destroy(); typePieChart = null; }
    typePieChart = new ApexCharts(document.querySelector('#typePie'), opts);
    typePieChart.render();
  }

  function drawMonthsBar(yearRows, selectedYear){
    const months = new Array(12).fill(0);
    const now = new Date();
    const todayLocal = toUTCDateOnly(now.getFullYear(), now.getMonth()+1, now.getDate());
    yearRows.forEach(r=>{
      if (r.date <= todayLocal) {
        months[r.date.getUTCMonth()] += normalizeQty(r.qty);
      }
    });
    const opts = { chart:{ type:'bar', height:300, foreColor: CHART_BASE, toolbar:{show:false} }, colors:[HEAD_RED],
      series:[{ name:'Designs', data: months }],
      xaxis:{ categories:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'] },
      dataLabels:{enabled:false} };
    if(monthsChart){ monthsChart.destroy(); monthsChart=null; }
    monthsChart = new ApexCharts(document.querySelector('#monthsBar'), opts); monthsChart.render();
    document.getElementById('monthsHint').textContent = selectedYear && selectedYear!=='all' ? `Year ${selectedYear}` : '';
  }

  function drawYearsBar(currentYearTotal){
    const labels = ['2020','2021','2022','2023','2024','2025'];
    const values = [4248, 6961, 12002, 9542, 10810, currentYearTotal];
    const opts = {
      chart:{ type:'bar', height:300, foreColor: CHART_BASE, toolbar:{show:false} },
      colors:[HEAD_RED],
      series:[{ name:'Designs', data: values }],
      xaxis:{ categories: labels },
      dataLabels:{ enabled:false }
    };
    if (yearsChart){ yearsChart.destroy(); yearsChart = null; }
    yearsChart = new ApexCharts(document.querySelector('#yearsBar'), opts);
    yearsChart.render();
  }

  function updateClientDetails(filtered){
    const sel = document.getElementById('clientSelect');
    const val = sel.value;

    const totalEl = document.getElementById('clientTotal');
    const typesEl = document.getElementById('clientTypes');
    const chEl    = document.getElementById('clientChannels');
    const desEl   = document.getElementById('clientDesigners');
    const lastEl  = document.getElementById('clientLastDate');

    if(!val){
      totalEl.textContent = '';
      typesEl.textContent = '';
      chEl.textContent    = '';
      desEl.textContent   = '';
      if (lastEl) lastEl.textContent = '';
      return;
    }

    const rows = filtered.filter(r => r.client === val);

    totalEl.innerHTML = `<strong>Total Designs:</strong> ${sumQty(rows)}`;

    const byType = {};
    rows.forEach(r=>{
      const k = canonicalType(r.type) || 'Unknown';
      byType[k] = (byType[k] || 0) + normalizeQty(r.qty);
    });
    typesEl.innerHTML = '<ul>' + Object.entries(byType)
      .sort((a,b)=> b[1]-a[1])
      .map(([t,q])=>`<li>${t}: ${q}</li>`).join('') + '</ul>';

    chEl.innerHTML  = `<strong>Channels:</strong> ${[...new Set(rows.map(r=>String(r.channel||'').trim()).filter(Boolean))].join(', ')}`;
    desEl.innerHTML = `<strong>Designers:</strong> ${[...new Set(rows.map(r=>r.designer).filter(Boolean))].join(', ')}`;

    const lastDate = rows.length ? new Date(Math.max(...rows.map(r => r.date.getTime()))) : null;
    if (lastEl){
      lastEl.innerHTML = `<strong>Last Design Date:</strong> ${lastDate ? fmtDDMMYYYY_UTC(lastDate) : '—'}`;
    }
  }

  function renderClientOptions(list, keep){
    const sel = document.getElementById('clientSelect'); const current = keep ? sel.value : '';
    sel.innerHTML = '<option value="">Select Channel</option>' + list.map(c=>`<option value="${c.replace(/"/g,'&quot;')}">${c}</option>`).join('');
    if(keep && current && list.includes(current)) sel.value = current; else sel.selectedIndex = 0;
  }

  // ===== Typeahead =====
  let TA_INDEX = -1;
  function escHTML(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function highlightMatch(text, q){
    const t = String(text), qq = String(q).toLowerCase();
    const i = t.toLowerCase().indexOf(qq);
    if(i<0 || !qq) return escHTML(t);
    return escHTML(t.slice(0,i)) + '<mark>' + escHTML(t.slice(i,i+qq.length)) + '</mark>' + escHTML(t.slice(i+qq.length));
  }
  function hideClientSuggestions(){
    const box = document.getElementById('clientSuggest');
    box.style.display='none'; box.innerHTML=''; TA_INDEX = -1;
  }
  function renderClientSuggestions(q){
    const box = document.getElementById('clientSuggest');
    const query = String(q||'').trim().toLowerCase();
    const matches = query ? CLIENTS.filter(c=> c.toLowerCase().includes(query)).slice(0,12) : CLIENTS.slice(0,12);
    if(!matches.length){
      box.innerHTML = `<div class="typeahead-empty">No matches</div>`;
      box.style.display = 'block'; TA_INDEX = -1; return;
    }
    box.innerHTML = matches.map((c,i)=> `<div class="typeahead-item${i===0?' active':''}" data-val="${escHTML(c)}">${highlightMatch(c, query)}</div>`).join('');
    box.style.display = 'block'; TA_INDEX = 0;
    box.querySelectorAll('.typeahead-item').forEach(el=>{
      el.addEventListener('mousedown', (ev)=>{
        ev.preventDefault();
        chooseClient(el.getAttribute('data-val'));
      });
    });
  }
  function chooseClient(val){
    const sel = document.getElementById('clientSelect');
    const exact = CLIENTS.find(c => c.toLowerCase() === String(val).toLowerCase());
    const chosen = exact || val;
    if (CLIENTS.includes(chosen)) { sel.value = chosen; }
    else {
      const near = CLIENTS.find(c=> c.toLowerCase().includes(String(val).toLowerCase()));
      if (near) sel.value = near;
    }
    sel.dispatchEvent(new Event('change'));
    document.getElementById('clientSearch').value = sel.value || String(val);
    hideClientSuggestions();
  }
  function moveActive(delta){
    const box = document.getElementById('clientSuggest');
    const items = Array.from(box.querySelectorAll('.typeahead-item'));
    if(!items.length) return;
    TA_INDEX = Math.max(0, Math.min(items.length-1, TA_INDEX + delta));
    items.forEach((it,idx)=> it.classList.toggle('active', idx===TA_INDEX));
    const active = items[TA_INDEX];
    if (active) active.scrollIntoView({block:'nearest'});
  }

  function applyFilters(){
    const yearVal = document.getElementById('yearSelect').value;
    const fromVal = document.getElementById('fromDate').value; const toVal = document.getElementById('toDate').value;
    const fromUTC = fromVal ? fromISODateOnly(fromVal) : null; const toUTC = toVal ? fromISODateOnly(toVal) : null;

    const yearBase = (yearVal==='all') ? RAW.slice() : RAW.filter(r=> r.date.getUTCFullYear() === Number(yearVal));
    let filtered = yearBase.slice();
    if(fromUTC) filtered = filtered.filter(r=> r.date >= fromUTC);
    if(toUTC)   filtered = filtered.filter(r=> r.date <= toUTC);

    LAST_FILTERED = filtered;

    // KPI: Year total
    document.getElementById('kpiYearTotal').textContent = sumQty(yearBase);

    // KPI: Range total
    document.getElementById('kpiRangeTotal').textContent = sumQty(filtered);

    // KPI: Daily Average = على عدد الأيام الظاهرة فعليًا
    const visibleDays = new Set(filtered.map(r => fmtDDMMYYYY_UTC(r.date))).size;
    document.getElementById('kpiRangeAvg').textContent = visibleDays ? (sumQty(filtered)/visibleDays).toFixed(2) : '--';

    // امسح أي نص تحت حقول التاريخ
    document.getElementById('fromDateDisp').textContent = '';
    document.getElementById('toDateDisp').textContent = '';

    drawMainArea(filtered);
    drawDesignerTotals(filtered);
    drawDesignerPies(filtered);
    drawTypeBar(filtered);
    drawTypePie(filtered);
    drawMonthsBar(yearBase, yearVal);

    // إجمالي السنة الحالية حتى اليوم
    const now = new Date();
    const todayLocal = toUTCDateOnly(now.getFullYear(), now.getMonth()+1, now.getDate());
    const currentYear = todayLocal.getUTCFullYear();
    const currentYearTotal = sumQty(RAW.filter(r => r.date.getUTCFullYear() === currentYear && r.date <= todayLocal));
    drawYearsBar(currentYearTotal);

    updateClientDetails(LAST_FILTERED);
  }

  async function init(){
    RAW = await loadData();
    if(!RAW.length){ console.warn('No data'); return; }

    const years = [...new Set(RAW.map(r=>r.date.getUTCFullYear()))].sort((a,b)=>b-a);
    const yearSelect = document.getElementById('yearSelect');
    yearSelect.innerHTML = '<option value="all">All</option>' + years.map(y=>`<option value="${y}">${y}</option>`).join('');

    const currentYear = new Date().getFullYear();
    if (years.includes(currentYear)) yearSelect.value = String(currentYear);

    CLIENTS = [...new Set(RAW.map(r=>r.client).filter(Boolean))].sort((a,b)=> a.localeCompare(b));
    renderClientOptions(CLIENTS, false);

    document.getElementById('btnApply').addEventListener('click', applyFilters);
    document.getElementById('btnClear').addEventListener('click', ()=>{
      document.getElementById('fromDate').value = '';
      document.getElementById('toDate').value   = '';
      applyFilters();
    });
    document.getElementById('btnThisWeek').addEventListener('click', ()=>{
      const now = new Date();
      const day = now.getDay(); // 0 Sun .. 6 Sat
      const diffToMon = (day===0? -6 : 1-day);
      const monLocal = new Date(now.getFullYear(), now.getMonth(), now.getDate()+diffToMon);
      const sunLocal = new Date(monLocal.getFullYear(), monLocal.getMonth(), monLocal.getDate()+6);
      const toISO = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      document.getElementById('fromDate').value = toISO(monLocal);
      document.getElementById('toDate').value   = toISO(sunLocal);
      applyFilters();
    });
    yearSelect.addEventListener('change', applyFilters);
    document.getElementById('clientSelect').addEventListener('change', ()=> updateClientDetails(LAST_FILTERED));

    // Typeahead listeners
    const searchInput = document.getElementById('clientSearch');
    const suggestBox = document.getElementById('clientSuggest');

    searchInput.addEventListener('input', (e)=>{
      renderClientSuggestions(e.target.value);
    });
    searchInput.addEventListener('keydown', (e)=>{
      if(suggestBox.style.display !== 'block') return;
      if(e.key === 'ArrowDown'){ e.preventDefault(); moveActive(+1); }
      else if(e.key === 'ArrowUp'){ e.preventDefault(); moveActive(-1); }
      else if(e.key === 'Enter'){
        e.preventDefault();
        const active = suggestBox.querySelector('.typeahead-item.active');
        const val = active ? active.getAttribute('data-val') : searchInput.value;
        chooseClient(val);
      } else if(e.key === 'Escape'){
        hideClientSuggestions();
      }
    });
    searchInput.addEventListener('focus', ()=> renderClientSuggestions(searchInput.value));
    document.addEventListener('click', (e)=>{
      if(!suggestBox.contains(e.target) && e.target !== searchInput){
        hideClientSuggestions();
      }
    });

    applyFilters();
  }

  init();
  </script>

</body>
</html>




