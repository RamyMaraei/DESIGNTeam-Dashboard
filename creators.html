<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CREATORS DASHBOARD</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <link href="https://fonts.googleapis.com/css2?family=Alexandria:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#f4f0ed; --text:#21000e; --box:#ffffff; --border:#21000e22;
      --control:#ffffff; --control-border:#21000e55; --red:#ff002b;
      --chart-base:#21000E; --link:#ff002b;
    }
    body{ background:var(--bg); color:var(--text); font-family:'Alexandria',sans-serif; }
    .card{ background:var(--box); border:1px solid var(--border); }
    .btn-primary{ background:var(--red)!important; border-color:var(--red)!important; }
    h1,.form-label{ color:var(--red); }
    a{ color:var(--link); }
    .expand-row{ background:#fafafa; }
  </style>
</head>
<body>
  <div class="container py-4">
    <!-- Logo -->
    <div class="d-flex justify-content-center mb-2">
      <img src="https://ramymaraei.github.io/banner-checker/ALFAN_LOGO-Small.png" alt="ALFAN Logo" style="max-height:56px;">
    </div>
    <h1 class="text-center fs-4 mb-4">CREATORS DASHBOARD</h1>

    <!-- Filters -->
    <div class="card p-3 mb-3">
      <div class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label">From</label>
          <input id="fromDate" type="date" class="form-control" />
        </div>
        <div class="col-md-3">
          <label class="form-label">To</label>
          <input id="toDate" type="date" class="form-control" />
        </div>
        <div class="col-md-3 d-flex gap-2">
          <button id="btnApply" class="btn btn-primary w-100">Apply</button>
          <a href="index.html" class="btn btn-outline-light w-100">Back</a>
        </div>
      </div>
    </div>

    <!-- Chart Top 10 -->
    <div class="card p-3 mb-3">
      <h2 class="fs-6 mb-3" style="color:var(--red)">Top 10 Creators</h2>
      <div id="topCreatorsChart"></div>
    </div>

    <!-- Creators Table -->
    <div class="card p-3">
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead><tr><th>Creator</th><th>Total Designs</th><th>Top Category</th><th></th></tr></thead>
          <tbody id="creatorsBody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
const SHEET_API = 'https://script.google.com/macros/s/AKfycbzl7CV83GMqgUMEK7CZlAJ-2s4aruOYeistkcpX_6mozP_e4c3DG4eMIEN7GQZcx4B6/exec';

function parseQty(v){ const n=Number(String(v??'').replace(/[^0-9.-]/g,'')); return Number.isFinite(n)?n:0; }
function parseDate(v){ if(!v) return null; const d=new Date(v); return isNaN(d)?null:new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())); }
function fmt(d){ return d?`${String(d.getUTCDate()).padStart(2,'0')}/${String(d.getUTCMonth()+1).padStart(2,'0')}/${d.getUTCFullYear()}`:''; }

let RAW=[];

async function loadData(){
  const res=await fetch(SHEET_API,{cache:'no-store'});
  const json=await res.json();
  return (Array.isArray(json)?json:[]).map(r=>({
    date: parseDate(r.Date),
    client: r.Client||'',
    qty: parseQty(r.Quantity),
    type: r.Type||'Unknown',
    designer: r.Designer||'',
    channel: r['Channel ID']||''
  })).filter(r=>r.date);
}

function groupCreators(rows){
  const map={};
  rows.forEach(r=>{
    if(!map[r.client]) map[r.client]={total:0,types:{},designers:new Set(),channels:new Set()};
    map[r.client].total+=r.qty;
    map[r.client].types[r.type]=(map[r.client].types[r.type]||0)+r.qty;
    if(r.designer) map[r.client].designers.add(r.designer);
    if(r.channel) map[r.client].channels.add(r.channel);
  });
  return map;
}

function renderTable(map){
  const body=document.getElementById('creatorsBody');
  body.innerHTML='';
  const sorted=Object.entries(map).sort((a,b)=>b[1].total-a[1].total);
  sorted.forEach(([name,info],idx)=>{
    const topType=Object.entries(info.types).sort((a,b)=>b[1]-a[1])[0]||['—',0];
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${name}</td><td>${info.total}</td><td>${topType[0]} (${topType[1]})</td><td><button class='btn btn-sm btn-outline-light' data-id='${idx}'>Details</button></td>`;
    body.appendChild(tr);
    const expand=document.createElement('tr');
    expand.className='expand-row';
    expand.style.display='none';
    expand.innerHTML=`<td colspan='4'>
      <div><strong>Types:</strong> ${Object.entries(info.types).map(([t,v])=>`${t} (${v})`).join(', ')||'—'}</div>
      <div><strong>Designers:</strong> ${[...info.designers].join(', ')||'—'}</div>
      <div><strong>Channels:</strong> ${[...info.channels].join(', ')||'—'}</div>
    </td>`;
    body.appendChild(expand);
  });
  body.querySelectorAll('button').forEach((btn,i)=>{
    btn.addEventListener('click',()=>{
      const row=body.querySelectorAll('.expand-row')[i];
      row.style.display=row.style.display==='none'?'table-row':'none';
    });
  });
}

function renderChart(map){
  const sorted=Object.entries(map).sort((a,b)=>b[1].total-a[1].total).slice(0,10);
  const labels=sorted.map(([n])=>n);
  const series=sorted.map(([,v])=>v.total);
  const options={
    chart:{type:'bar',height:350,foreColor:'var(--chart-base)',fontFamily:'Alexandria, sans-serif'},
    series:[{name:'Designs',data:series}],
    xaxis:{categories:labels},
    colors:['var(--chart-base)'],
    dataLabels:{enabled:false}
  };
  document.querySelector('#topCreatorsChart').innerHTML='';
  new ApexCharts(document.querySelector('#topCreatorsChart'),options).render();
}

function applyFilters(){
  const from=document.getElementById('fromDate').value;
  const to=document.getElementById('toDate').value;
  const fromD=from?parseDate(from):null;
  const toD=to?parseDate(to):null;
  let rows=RAW;
  if(fromD) rows=rows.filter(r=>r.date>=fromD);
  if(toD) rows=rows.filter(r=>r.date<=toD);
  const map=groupCreators(rows);
  renderTable(map);
  renderChart(map);
}

(async function init(){
  RAW=await loadData();
  document.getElementById('btnApply').addEventListener('click',applyFilters);
  applyFilters();
})();
</script>
</body>
</html>

