<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CREATORS DASHBOARD</title>

  <!-- Bootstrap + Font -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Alexandria:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f4f0ed; --text:#21000e; --box:#ffffff; --border:#21000e22;
      --control:#ffffff; --control-border:#21000e55; --red:#ff002b;
      --chart-base:#21000E; --link:#ff002b;
    }
    body{ background:var(--bg); color:var(--text); font-family:'Alexandria',sans-serif; }
    .card{ background:var(--box); border:1px solid var(--border); }
    .form-select,.form-control{ background:var(--control); color:var(--text); border-color:var(--control-border); }
    .btn-primary,.btn-outline-light{ background:var(--red)!important; border-color:var(--red)!important; color:#fff!important; }
    h1,.form-label{ color:var(--red); }
    a{ color:var(--link); }
    .toolbar{ display:flex; gap:.5rem; align-items:center; margin-bottom:1rem; }
    .toolbar .right{ margin-left:auto; display:flex; gap:.5rem; }
    .expand-details{ background:#fafafa; border-top:1px solid var(--border); padding:1rem; }
    .muted{ color:#6b7280; font-size:.85rem; }
    footer{ text-align:center; padding:1rem; font-size:.9rem; color:var(--text); border-top:1px solid var(--border); margin-top:1rem; }
  </style>
</head>
<body>
  <div class="container py-4">

    <!-- الشعار -->
    <div class="d-flex align-items-center justify-content-center mb-2">
      <img src="https://ramymaraei.github.io/banner-checker/ALFAN_LOGO-Small.png" alt="ALFAN Logo" style="max-height:56px;">
    </div>

    <!-- العنوان -->
    <div class="d-flex align-items-center justify-content-center mb-3">
      <h1 class="fs-4 m-0 text-center">CREATORS DASHBOARD</h1>
    </div>

    <!-- أدوات التحكم -->
    <div class="card p-3 mb-3">
      <div class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label">From</label>
          <input id="fromDate" type="date" class="form-control" />
        </div>
        <div class="col-md-3">
          <label class="form-label">To</label>
          <input id="toDate" type="date" class="form-control" />
        </div>
        <div class="col-md-3">
          <button id="btnApply" class="btn btn-primary w-100">Apply</button>
        </div>
        <div class="col-md-3">
          <a href="index.html" class="btn btn-primary w-100">Back</a>
        </div>
      </div>
    </div>

    <!-- Chart -->
    <div class="card p-3 mb-3">
      <h2 class="fs-6 mb-3" style="color:var(--red)">Top 10 Creators</h2>
      <div id="topChart"></div>
    </div>

    <!-- Toolbar above table -->
    <div class="toolbar">
      <span style="font-weight:600;">Creators List</span>
      <div class="right">
        <button id="btnCSV" class="btn btn-primary btn-sm">Export CSV</button>
        <button id="btnXLSX" class="btn btn-primary btn-sm">Export Excel</button>
      </div>
    </div>

    <!-- Table -->
    <div class="card p-3">
      <div class="table-responsive">
        <table class="table table-sm table-striped align-middle" id="creatorsTable">
          <thead>
            <tr><th>Creator</th><th>Total Designs</th><th>Top Type</th><th>Details</th></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Footer -->
    <footer>
      شركة الفان – تصميم وتنفيذ رامي مرعي | Alfan - DESIGNTeam Dashboard - Ramy Maraei © 2025
    </footer>

  </div>

  <script>
    const SHEET_API = 'https://script.google.com/macros/s/AKfycbzl7CV83GMqgUMEK7CZlAJ-2s4aruOYeistkcpX_6mozP_e4c3DG4eMIEN7GQZcx4B6/exec';
    let RAW = [];

    function normalizeQty(v){
      if (!v) return 0;
      let s = String(v).trim().replace(/,/g,'');
      return parseFloat(s)||0;
    }

    async function loadData(){
      const res = await fetch(SHEET_API);
      const json = await res.json();
      return (Array.isArray(json)?json:[]).map(r=>({
        date: new Date(r.Date),
        creator: r.Client||'',
        type: r.Type||'Unknown',
        designer: r.Designer||'',
        qty: normalizeQty(r.Quantity)
      }));
    }

    function groupData(rows){
      const map = {};
      rows.forEach(r=>{
        if(!map[r.creator]) map[r.creator]={total:0,byType:{},designers:new Set()};
        map[r.creator].total += r.qty;
        map[r.creator].byType[r.type]=(map[r.creator].byType[r.type]||0)+r.qty;
        map[r.creator].designers.add(r.designer);
      });
      return map;
    }

    function renderTable(map){
      const body=document.getElementById('tableBody');
      body.innerHTML='';
      const creators=Object.entries(map).sort((a,b)=>b[1].total-a[1].total);
      creators.forEach(([creator,data])=>{
        const topType=Object.entries(data.byType).sort((a,b)=>b[1]-a[1])[0]||['—',0];
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${creator}</td>
          <td>${data.total}</td>
          <td>${topType[0]} (${topType[1]})</td>
          <td><button class="btn btn-primary btn-sm" data-creator="${creator}">Details</button></td>`;
        body.appendChild(tr);

        const details=document.createElement('tr');
        details.style.display='none';
        details.classList.add('expand-details-row');
        details.innerHTML=`<td colspan="4">
          <div class="expand-details">
            <strong>Types:</strong><br>
            ${Object.entries(data.byType).map(([t,v])=>`${t}: ${v}`).join('<br>')}<br>
            <strong>Designers:</strong> ${[...data.designers].join(', ')||'—'}
          </div>
        </td>`;
        body.appendChild(details);

        tr.querySelector('button').addEventListener('click',()=>{
          details.style.display=details.style.display==='none'?'':'none';
        });
      });
    }

    function renderChart(map){
      const creators=Object.entries(map).sort((a,b)=>b[1].total-a[1].total).slice(0,10);
      const labels=creators.map(c=>c[0]);
      const data=creators.map(c=>c[1].total);
      new ApexCharts(document.querySelector('#topChart'),{
        chart:{type:'bar',height:350,toolbar:{show:false}},
        series:[{name:'Designs',data:data}],
        xaxis:{categories:labels},
        colors:['#21000E']
      }).render();
    }

    function exportCSV(map){
      const creators=Object.entries(map).sort((a,b)=>b[1].total-a[1].total);
      let csv='Creator,Total Designs\n';
      creators.forEach(([c,d])=>{csv+=`"${c}",${d.total}\n`;});
      const blob=new Blob([csv],{type:'text/csv'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;a.download='creators.csv';a.click();URL.revokeObjectURL(url);
    }

    function exportXLSX(map){
      const creators=Object.entries(map).sort((a,b)=>b[1].total-a[1].total);
      const rows=creators.map(([c,d])=>({Creator:c,Total:d.total}));
      const wb=XLSX.utils.book_new();
      const ws=XLSX.utils.json_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb,ws,'Creators');
      XLSX.writeFile(wb,'creators.xlsx');
    }

    (async function init(){
      RAW=await loadData();
      const from=document.getElementById('fromDate');
      const to=document.getElementById('toDate');
      document.getElementById('btnApply').addEventListener('click',()=>{
        let filtered=RAW;
        if(from.value) filtered=filtered.filter(r=>r.date>=new Date(from.value));
        if(to.value) filtered=filtered.filter(r=>r.date<=new Date(to.value));
        const map=groupData(filtered);
        renderTable(map);
        document.getElementById('topChart').innerHTML='';
        renderChart(map);
      });

      document.getElementById('btnCSV').addEventListener('click',()=>exportCSV(groupData(RAW)));
      document.getElementById('btnXLSX').addEventListener('click',()=>exportXLSX(groupData(RAW)));

      const map=groupData(RAW);
      renderTable(map);
      renderChart(map);
    })();
  </script>
</body>
</html>
